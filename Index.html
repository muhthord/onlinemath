<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
    <link href="https://fonts.googleapis.com/css2?family=Mali:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Mali', cursive; background-color: #e0f7fa; margin: 0; padding: 20px; color: #444; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; text-align: center; }
        input, select { padding: 10px; margin: 10px; border-radius: 10px; border: 1px solid #ccc; width: 80%; font-family: 'Mali'; }
        button { background-color: #ff8a80; color: white; border: none; padding: 10px 25px; border-radius: 25px; cursor: pointer; font-size: 16px; margin: 5px; font-family: 'Mali'; transition: 0.3s; }
        button:hover { background-color: #ff5252; transform: scale(1.05); }
        .hidden { display: none; }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 15px; margin-top: 10px; background: black; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .assignment-zone { background: #f1f8e9; padding: 15px; border-radius: 15px; margin-top: 15px; border: 2px dashed #aed581; }
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 999; font-size: 20px; color: #006064; }
    </style>
</head>
<body>

    <div id="loading" class="loading hidden">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

    <div class="container">
        
        <div id="page-login" class="card">
            <h2 style="color:#006064">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</h2>
            <button onclick="toggleLogin('student')" style="background:#4db6ac">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
            <button onclick="toggleLogin('teacher')" style="background:#ffb74d">‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</button>
            
            <div id="form-student" style="margin-top:20px;">
                <input type="text" id="std-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                <select id="std-class">
                    <option value="1/3">‡∏°.1/3</option>
                    <option value="1/5">‡∏°.1/5</option>
                    <option value="1/6">‡∏°.1/6</option>
                </select>
                <input type="text" id="std-no" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà">
                <br><button onclick="loginStudent()">‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
            </div>

            <div id="form-teacher" class="hidden" style="margin-top:20px;">
                <input type="text" id="tch-user" placeholder="User (T123)">
                <input type="password" id="tch-pass" placeholder="Password">
                <br><button onclick="loginTeacher()">Login ‡∏Ñ‡∏£‡∏π</button>
            </div>
        </div>

        <div id="page-student" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ <b id="display-name"></b></span>
                <button onclick="location.reload()" style="background:#90a4ae; font-size:12px;">‡∏≠‡∏≠‡∏Å</button>
            </div>
            <div id="lesson-list"></div>
        </div>

        <div id="page-teacher" class="hidden">
             <div class="card">
                <h3>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô (‡∏Ñ‡∏£‡∏π)</h3>
                <button onclick="location.reload()" style="background:#90a4ae">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                <div id="teacher-content" style="text-align:left; margin-top:10px;"></div>
             </div>
        </div>

        <div style="text-align:center; margin-top:30px; color:#006064; font-size:12px;">
            ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÇ‡∏î‡∏¢ ‡∏ô‡∏≤‡∏¢‡∏ß‡∏∏‡∏í‡∏¥‡∏ä‡∏±‡∏¢ ‡∏ô‡∏∏‡πà‡∏°‡∏ô‡πâ‡∏≠‡∏¢
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // ******************************************************
        // ‚ö†Ô∏è ‡πÄ‡∏≠‡∏≤ URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Google Apps Script ‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
        const API_URL = "https://script.google.com/macros/s/AKfycbzd7qlXqORPwGhQZuHAPrilOaL6TPEtCtMzJD_wFrGWqtw2sU1kvsAkOQiRNhYi8fat/exec"


        let currentUser = {};
        let player;

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function toggleLogin(type) {
            document.getElementById('form-student').classList.toggle('hidden', type !== 'student');
            document.getElementById('form-teacher').classList.toggle('hidden', type !== 'teacher');
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏≤ Google Sheet
        async function callAPI(action, payload = {}) {
            showLoading(true);
            try {
                // ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ POST ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á CORS ‡πÉ‡∏ô‡∏ö‡∏≤‡∏á‡∏Å‡∏£‡∏ì‡∏µ ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡πÄ‡∏¢‡∏≠‡∏∞
                const response = await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({ action, ...payload })
                });
                const data = await response.json();
                showLoading(false);
                return data;
            } catch (e) {
                console.error(e);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: " + e);
                showLoading(false);
            }
        }

        async function loginStudent() {
            const name = document.getElementById('std-name').value;
            const cls = document.getElementById('std-class').value;
            const no = document.getElementById('std-no').value;
            
            if(!name || !no) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
            
            const res = await callAPI('login', { name, class: cls, no });
            if (res && res.success) {
                currentUser = res;
                document.getElementById('display-name').innerText = res.name;
                document.getElementById('page-login').classList.add('hidden');
                document.getElementById('page-student').classList.remove('hidden');
                loadLessons();
            }
        }

        async function loginTeacher() {
            const u = document.getElementById('tch-user').value;
            const p = document.getElementById('tch-pass').value;
            const res = await callAPI('teacherLogin', { user: u, pass: p });
            if (res.success) {
                document.getElementById('page-login').classList.add('hidden');
                document.getElementById('page-teacher').classList.remove('hidden');
                loadTeacherStats();
            } else {
                alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î");
            }
        }

        async function loadLessons() {
            const lessons = await callAPI('getLessons', { studentId: currentUser.id });
            const container = document.getElementById('lesson-list');
            container.innerHTML = "";
            
            lessons.forEach((l, idx) => {
                let html = `
                <div class="card">
                    <h3>‡∏ö‡∏ó‡∏ó‡∏µ‡πà ${idx+1}: ${l.title} ${l.watched ? '‚úÖ' : ''}</h3>
                    ${!l.watched ? 
                        `<div class="video-container" id="vid-box-${idx}"><div id="player-${idx}"></div></div>
                         <button onclick="startVideo('${l.yt}', ${idx}, '${l.id}')" style="margin-top:10px;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>` 
                        : `<p style="color:green; font-weight:bold">‡∏î‡∏π‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß</p>`
                    }
                    
                    <div id="assign-${idx}" class="assignment-zone ${l.watched ? '' : 'hidden'}">
                        <p>üìÑ <a href="${l.doc}" target="_blank">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</a></p>
                        ${l.submitted ? 
                            '<p style="color:green">‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚úÖ</p>' :
                            `<div>
                                <input type="file" id="file-${l.id}" accept="image/*,.pdf">
                                <button onclick="uploadWork('${l.id}')" style="font-size:12px;">‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>
                             </div>`
                        }
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }

        // Video Logic
        function startVideo(ytId, idx, lessonId) {
            if(player) player.destroy();
            player = new YT.Player(`player-${idx}`, {
                height: '360', width: '640', videoId: ytId,
                events: {
                    'onStateChange': (e) => {
                        if (e.data == YT.PlayerState.ENDED) {
                            markWatched(lessonId, idx);
                        }
                    }
                }
            });
        }

        async function markWatched(lessonId, idx) {
            await callAPI('markWatched', { studentId: currentUser.id, lessonId });
            alert("‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å! ‡∏î‡∏π‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏ó‡∏≥‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢");
            document.getElementById(`vid-box-${idx}`).innerHTML = ""; // ‡∏•‡∏ö‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏≠‡∏≠‡∏Å
            document.getElementById(`assign-${idx}`).classList.remove('hidden');
            loadLessons(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        }

        async function uploadWork(lessonId) {
            const fileInput = document.getElementById(`file-${lessonId}`);
            if (fileInput.files.length === 0) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô");
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64 = e.target.result;
                const res = await callAPI('upload', {
                    fileData: base64,
                    fileName: file.name,
                    studentId: currentUser.id,
                    lessonId: lessonId
                });
                if(res.success) {
                    alert("‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                    loadLessons();
                } else {
                    alert("‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + res.error);
                }
            };
            reader.readAsDataURL(file);
        }

        async function loadTeacherStats() {
            const data = await callAPI('getStats', {});
            let html = "<ul style='list-style:none; padding:0;'>";
            data.forEach(d => {
                if(d.user) {
                    let parts = d.user.split('_');
                    html += `<li style="border-bottom:1px solid #ddd; padding:5px;">
                        <b>${parts[0]} (${parts[1]})</b> - ‡∏ö‡∏ó: ${d.lesson} [${d.status}] 
                        ${d.link ? `<a href="${d.link}" target="_blank">‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô</a>` : ''}
                    </li>`;
                }
            });
            html += "</ul>";
            document.getElementById('teacher-content').innerHTML = html;
        }
    </script>
</body>
</html>
